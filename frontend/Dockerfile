FROM node:lts as build

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

ARG ARG_PORT
ARG ARG_REACT_APP_BACKEND
ARG ARG_REACT_APP_INTRA_UID
ARG ARG_REACT_APP_REDIRECT_URI
ARG ARG_REACT_APP_CHAT_SOCKET
ARG ARG_REACT_APP_GAME_SOCKET
ARG ARG_REACT_APP_USER_SOCKET
ARG ARG_REACT_APP_TESTING


ENV PORT=${ARG_PORT}
ENV REACT_APP_BACKEND=${ARG_REACT_APP_BACKEND}
ENV REACT_APP_INTRA_UID=${ARG_REACT_APP_INTRA_UID}
ENV REACT_APP_REDIRECT_URI=${ARG_REACT_APP_REDIRECT_URI}
ENV REACT_APP_CHAT_SOCKET=${ARG_REACT_APP_CHAT_SOCKET}
ENV REACT_APP_GAME_SOCKET=${ARG_REACT_APP_GAME_SOCKET}
ENV REACT_APP_USER_SOCKET=${ARG_REACT_APP_USER_SOCKET}
ENV REACT_APP_TESTING=${ARG_REACT_APP_TESTING}

RUN npm run build

FROM nginx:alpine

COPY --from=build /app/nginx.conf /etc/nginx/conf.d/default.conf

COPY --from=build /app/build /usr/share/nginx/html

COPY --from=build /app/certification/. /etc/nginx/ssl/.


EXPOSE 80
EXPOSE 443